# Process

Процесс в Ergo Framework - это актор в виде надстройки над легковесной goroutine, в которую включен набор необходимых методов и свойств. Взаимодействие между такими процессами производится с помощью обмена сообщениями. Для этих целей в процессе имеется mailbox, куда помещаются все приходящие сообщения. В действительности, mailbox это буферизированный канал, размер которого можно задать в момент запуска процесса c помощью [`gen.ProcessOptions`](https://pkg.go.dev/github.com/ergo-services/ergo/gen#ProcessOptions).

### Природа процесса в Ergo Framework

Процессы запускаются и живут в рамках ноды. Каждый процесс имеет свой уникальный идентификатор `etf.Pid`. Он включает в себя имя ноды, уникальный порядковый номер в рамках ноды, а также свойство `Creation`. Этот набор свойств позволяет:

* Идентифицировать процесс даже на удаленной ноде. По имени ноды процесса производится маршрутизация сообщения.
* Свойство `Creation` дает возможность определить "инкарнацию" процесса. Это свойство имеет одинаковое значение для всех запущенных процессов в рамках ноды. Если нода будет перезапущена, то поле `Creation` будет имееть другое значение (в действительности, в этом поле хранится timestamp запуска ноды).  Eсли отправить сообщение процессу с идентификатором `etf.Pid`, принадлещему предыдущей инкарнации ноды, то вернется ошибка `node.ErrProcessIncarnation`.

Когда нода создает процесс, она возвращает не объект этого процесса, а интерфейс работы с ним - `gen.Process`. Таким образом достигается изоляция объекта процесса. Интерфейс `gen.Process` включает в себя обширный набор методов для управления процессом, а также отправки асинхронных сообщений. Также, в `gen.Process` встроен интерфейс `gen.Core` - это набор методов самой ноды (например, методы поиска процесса по имени или по `etf.Pid`, или по алиасу `etf.Alias`). Полный набор методов можно посмотреть в референсной документации для [`gen.Core`](https://pkg.go.dev/github.com/ergo-services/ergo/gen#Core) и [`gen.Process`](https://pkg.go.dev/github.com/ergo-services/ergo/gen#Process).

### Старт процесса

Чтобы запустить новый процесс, необходимо создать объект с встроенным в него behavior:

```go
type Example struct {
    gen.Server
    A string
    B int
}
```

Cозданный объект с типом `Example` унаследует методы и свойства `gen.Server`, который в свою очередь включает в себя методы `gen.Process`. В качестве базового behavior может быть использован любой из поставляемых с Ergo Framework готовых behavior (см. раздел [Generic Behaviors](broken-reference)). Вы также можете создавать свои behavior и использовать их для создания объектов процессов. Как это делается описано в разделе [Custom Behavior](../advanced/custom-behavior.md).

Запуск процесса осуществляется методом `Spawn`. Этот метод присутствует в интерфейсах `node.Node` и `gen.Process`. Разница лишь в том, что процесс, запущенный методом `gen.Process.Spawn()` получает информацию о своем родителе. В этом случае метод `gen.Process.Parent()` созданного процесса вернет интефейс `gen.Process` родительского процесса. Этот механизм носит лишь информационных характер и останов родительского процесса никак не влияет на работу дочернего.

Метод Spawn имеет ряд аргументов для запуска процесса:

```go
Spawn(name string,
      opts gen.ProcessOptions,
      object gen.ProcessBehavior, 
      args ...etf.Term) (gen.Process, error)
```

Аргумент `name` определяет имя процесса, под которым он должен быть зарегистрировать в процесса запуска. Если такое имя уже занято другим процессом, то вернется ошибка node.ErrTaken. Это поле можно оставить пустым и воспользоваться методом `gen.Process.Register(name string)` позже.

Аргумент `object`. Здесь стоит обратить внимание на его тип `gen.ProcessBehavior`. Когда вы создаете объект Example он включает в себя набор методов `gen.Server` (а также унаследованный набор методов от `gen.Process`) - все эти методы предназначены для использования вами, как разработчиком. В то же время, этот объект должен удовлетворять интефейсу, который предназначен для работы самой ноды - тот самый набор callback методов `gen.ProcessBehavior`.&#x20;

{% hint style="info" %}
Когда вы создаете объект с встроенным `gen.Server` вы автоматически получаете реализацию интерфейса `gen.ProcessBehavior`. Вместе с этим, gen.Server включает в себя расширенный набор callback методов `gen.ServerBehavior, например` callback `Init(...)`, который вызывается в момент старта процесса. Или callback метод`HandleInfo(...)`когда приходит сообщение этому процессу.
{% endhint %}

Аргумент `args` является вариативным (переменной длины). Он передается в callback метод `Init(process *gen.ServerProcess, args... etf.Term)` в момент старта процесса.

Таким образом, код старта процесса будет выглядеть следующим образом:

```go
type Example struct {
    gen.Server
    A string
    B int
}

func (e *Example) Init(process *gen.ServerProcess, args ... etf.Term) error {
    fmt.Println("Hello! My name is", process.Name())
    fmt.Println("and my PID is", process.Self())
    return nil
}

func main() {
    node, _ := ergo.StartNode("node@localhost", "cookies", node.Options{})
    process, _ := node.Spawn("example", gen.ProcessOptions{}, &Example{})
    node.Stop()
}
```

Код различных примеров вы можете посмотреть в директории examples исходного кода Ergo Framework. Или в репозитории проекта  [https://github.com/ergo-services/ergo/tree/master/examples](https://github.com/ergo-services/ergo/tree/master/examples).

### Останов процесса

Любой процесс может быть остановлен по ряду причин:
